name: Full FFmpeg Manual Build (MSYS2)

on:
  workflow_dispatch:
  push:
    branches: [ master, main ]

jobs:
  build:
    name: Build ${{ matrix.msystem }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - msystem: MINGW64
            arch: x86_64
            prefix: mingw-w64-x86_64
            name: win64
          - msystem: MINGW32
            arch: i686
            prefix: mingw-w64-i686
            name: win32

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout Your Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整提交记录以便生成版本号

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msystem }}
          update: true
          install: >-
            base-devel
            git
            make
            yasm
            nasm
            gcc
            pkg-config
            diffutils
            ${{ matrix.prefix }}-toolchain
            ${{ matrix.prefix }}-zlib
            ${{ matrix.prefix }}-libx264
            ${{ matrix.prefix }}-libx265
            ${{ matrix.prefix }}-libvpx
            ${{ matrix.prefix }}-libaom
            ${{ matrix.prefix }}-dav1d
            ${{ matrix.prefix }}-lame
            ${{ matrix.prefix }}-fdk-aac
            ${{ matrix.prefix }}-opus
            ${{ matrix.prefix }}-libvorbis
            ${{ matrix.prefix }}-libtheora
            ${{ matrix.prefix }}-libass
            ${{ matrix.prefix }}-libwebp
            ${{ matrix.prefix }}-libxml2
            ${{ matrix.prefix }}-freetype
            ${{ matrix.prefix }}-fontconfig
            ${{ matrix.prefix }}-fribidi
            ${{ matrix.prefix }}-gmp
            ${{ matrix.prefix }}-gnutls
            ${{ matrix.prefix }}-srt
            ${{ matrix.prefix }}-soxr
            ${{ matrix.prefix }}-rav1e
            ${{ matrix.prefix }}-libzimg

      - name: Configure FFmpeg
        run: |
          # 创建构建目录
          mkdir -p build_dir
          cd build_dir

          # 这里的关键是 PKG_CONFIG_PATH，让 FFmpeg 找到刚才 pacman 安装的库
          # MSYS2 会自动处理环境变量，所以我们直接运行 configure

          # 解释一下关键参数：
          # --enable-static --disable-shared: 编译为静态 exe
          # --pkg-config-flags="--static": 告诉 pkg-config 获取静态库的链接参数（非常重要！）
          # --extra-ldflags="-static": 强制链接静态 C 运行库

          ../configure \
            --prefix=../install_dir \
            --arch=${{ matrix.arch }} \
            --target-os=mingw32 \
            --pkg-config-flags="--static" \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            --enable-static \
            --disable-shared \
            --disable-debug \
            --disable-doc \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libvpx \
            --enable-libaom \
            --enable-libdav1d \
            --enable-libmp3lame \
            --enable-libfdk-aac \
            --enable-libopus \
            --enable-libvorbis \
            --enable-libtheora \
            --enable-libass \
            --enable-libwebp \
            --enable-libxml2 \
            --enable-libfreetype \
            --enable-libfontconfig \
            --enable-libfribidi \
            --enable-libgmp \
            --enable-gnutls \
            --enable-libsrt \
            --enable-libsoxr \
            --enable-librav1e \
            --enable-libzimg \
            --extra-cflags="-static" \
            --extra-ldflags="-static -static-libgcc -static-libstdc++"

      - name: Compile FFmpeg
        run: |
          cd build_dir
          make -j$(nproc)
          make install

      - name: Organize Artifacts
        shell: pwsh
        run: |
          # 这是一个 PowerShell 步骤，用于整理文件
          # 将生成的 exe 移动到根目录方便打包
          mkdir artifacts
          Copy-Item install_dir/bin/ffmpeg.exe artifacts/ffmpeg-${{ matrix.name }}.exe
          Copy-Item install_dir/bin/ffprobe.exe artifacts/ffprobe-${{ matrix.name }}.exe

      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.name }}-full
          path: artifacts/*
