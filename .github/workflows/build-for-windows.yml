name: Full FFmpeg Manual Build (MSYS2)

on:
  workflow_dispatch:
  push:
    branches: [ master, main ]

jobs:
  build:
    name: Build ${{ matrix.msystem }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- 64位 配置 (满血版) ---
          - msystem: MINGW64
            arch: x86_64
            prefix: mingw-w64-x86_64
            name: win64
            # 64位包含 rav1e 和 fdk-aac
            extra_deps: >-
              mingw-w64-x86_64-rav1e
              mingw-w64-x86_64-fdk-aac
            # 64位开启的额外 FFmpeg 参数
            extra_conf: >-
              --enable-librav1e
              --enable-libfdk-aac

          # --- 32位 配置 (兼容版) ---
          - msystem: MINGW32
            arch: i686
            prefix: mingw-w64-i686
            name: win32
            # 32位不包含 rav1e (官方源无包) 和 fdk-aac (避免报错)，使用内置 AAC
            extra_deps: ""
            extra_conf: ""

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout Your Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msystem }}
          update: true
          # 核心依赖 + 矩阵中定义的额外依赖
          install: >-
            base-devel
            git
            make
            yasm
            nasm
            gcc
            pkg-config
            diffutils
            ${{ matrix.prefix }}-toolchain
            ${{ matrix.prefix }}-zlib
            ${{ matrix.prefix }}-libx264
            ${{ matrix.prefix }}-x265
            ${{ matrix.prefix }}-libvpx
            ${{ matrix.prefix }}-aom
            ${{ matrix.prefix }}-dav1d
            ${{ matrix.prefix }}-lame
            ${{ matrix.prefix }}-opus
            ${{ matrix.prefix }}-libvorbis
            ${{ matrix.prefix }}-libtheora
            ${{ matrix.prefix }}-libass
            ${{ matrix.prefix }}-libwebp
            ${{ matrix.prefix }}-libxml2
            ${{ matrix.prefix }}-freetype
            ${{ matrix.prefix }}-fontconfig
            ${{ matrix.prefix }}-fribidi
            ${{ matrix.prefix }}-gmp
            ${{ matrix.prefix }}-gnutls
            ${{ matrix.prefix }}-srt
            ${{ matrix.prefix }}-libsoxr
            ${{ matrix.prefix }}-zimg
            ${{ matrix.extra_deps }}

      - name: Configure FFmpeg
        run: |
          mkdir -p build_dir
          cd build_dir

          # 已删除报错的 --enable-libgmp
          # 动态添加了 matrix.extra_conf (区分32/64位参数)
          
          ../configure \
            --prefix=../install_dir \
            --arch=${{ matrix.arch }} \
            --target-os=mingw32 \
            --pkg-config-flags="--static" \
            --enable-gpl \
            --enable-version3 \
            --enable-nonfree \
            --enable-static \
            --disable-shared \
            --disable-debug \
            --disable-doc \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libvpx \
            --enable-libaom \
            --enable-libdav1d \
            --enable-libmp3lame \
            --enable-libopus \
            --enable-libvorbis \
            --enable-libtheora \
            --enable-libass \
            --enable-libwebp \
            --enable-libxml2 \
            --enable-libfreetype \
            --enable-libfontconfig \
            --enable-libfribidi \
            --enable-gnutls \
            --enable-libsrt \
            --enable-libsoxr \
            --enable-libzimg \
            ${{ matrix.extra_conf }} \
            --extra-cflags="-static" \
            --extra-ldflags="-static -static-libgcc -static-libstdc++"

      - name: Compile FFmpeg
        run: |
          cd build_dir
          make -j$(nproc)
          make install

      - name: Organize Artifacts
        shell: pwsh
        run: |
          mkdir artifacts
          if (Test-Path install_dir/bin/ffmpeg.exe) {
            Copy-Item install_dir/bin/ffmpeg.exe artifacts/ffmpeg-${{ matrix.name }}.exe
          }
          if (Test-Path install_dir/bin/ffprobe.exe) {
            Copy-Item install_dir/bin/ffprobe.exe artifacts/ffprobe-${{ matrix.name }}.exe
          }

      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.name }}-full
          path: artifacts/*
